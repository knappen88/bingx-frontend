name: Build iOS App

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
        - debug
        - release

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build React app
      run: npm run build
      env:
        REACT_APP_API_URL: https://api.marketshadows.club/api
        
    - name: âš¡ Setup Capacitor
      run: |
        npm install @capacitor/core @capacitor/cli @capacitor/ios
        npx cap add ios
        npx cap copy ios
        
    - name: ğŸ Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: ğŸ”¨ Build iOS App (Debug)
      if: github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == ''
      run: |
        cd ios/App
        xcodebuild -workspace App.xcworkspace \
                   -scheme App \
                   -destination 'generic/platform=iOS Simulator' \
                   -configuration Debug \
                   build
                   
    - name: ğŸ“± Create IPA (Simulator)
      if: github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == ''
      run: |
        cd ios/App
        xcodebuild -workspace App.xcworkspace \
                   -scheme App \
                   -destination 'generic/platform=iOS Simulator' \
                   -configuration Debug \
                   -archivePath BingX-Analytics.xcarchive \
                   archive
                   
    - name: ğŸ“¤ Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: BingX-Analytics-iOS
        path: ios/App/BingX-Analytics.xcarchive
        retention-days: 30
        
    - name: ğŸ“Š Build Summary
      run: |
        echo "âœ… iOS build completed successfully!"
        echo "ğŸ“± App: BingX Analytics"
        echo "ğŸ·ï¸ Bundle ID: com.marketshadows.bingx"
        echo "ğŸ“¦ Artifact uploaded: BingX-Analytics-iOS"